# Supabase Edge Functions Setup Guide\n\nThis guide covers the setup and deployment of SceneScout's scheduled scraping Edge Functions.\n\n## üöÄ Edge Functions Overview\n\n### Core Scraping Functions\n\n1. **scheduled-scraper** - Main cron job handler (runs every 30 minutes)\n2. **city-scraper** - City-specific scraping operations\n3. **venue-scraper** - Venue-specific event scraping\n4. **webhook-handler** - Real-time webhook processing\n5. **health-check** - System monitoring and alerting\n6. **rpc-functions** - Database RPC operations and geo-queries\n\n## üìã Prerequisites\n\n```bash\n# Install Supabase CLI\nnpm install -g supabase@latest\n\n# Login to Supabase\nsupabase login\n\n# Initialize project (if not already done)\nsupabase init\n```\n\n## üîß Local Development Setup\n\n### 1. Start Supabase Services\n\n```bash\n# Start all services\nsupabase start\n\n# Check service status\nsupabase status\n```\n\n### 2. Apply Database Migrations\n\n```bash\n# Apply migrations\nsupabase db reset\n\n# Or apply specific migration\nsupabase db push\n```\n\n### 3. Set Environment Variables\n\nCreate `.env.local` file:\n\n```bash\n# Supabase\nSUPABASE_URL=http://127.0.0.1:54321\nSUPABASE_ANON_KEY=your-anon-key\nSUPABASE_SERVICE_ROLE_KEY=your-service-role-key\n\n# External APIs\nEVENTBRITE_API_TOKEN=your-eventbrite-token\nTICKETMASTER_API_KEY=your-ticketmaster-key\n\n# Webhook Secrets\nEVENTBRITE_WEBHOOK_SECRET=your-webhook-secret\nTICKETMASTER_WEBHOOK_SECRET=your-webhook-secret\nINTERNAL_WEBHOOK_SECRET=your-internal-secret\n```\n\n### 4. Deploy Functions Locally\n\n```bash\n# Serve functions locally\nsupabase functions serve\n\n# Or serve specific function\nsupabase functions serve scheduled-scraper\n```\n\n## üåê Production Deployment\n\n### 1. Set Production Environment Variables\n\n```bash\n# Set secrets in Supabase Dashboard or CLI\nsupabase secrets set EVENTBRITE_API_TOKEN=your-production-token\nsupabase secrets set TICKETMASTER_API_KEY=your-production-key\nsupabase secrets set EVENTBRITE_WEBHOOK_SECRET=your-webhook-secret\nsupabase secrets set TICKETMASTER_WEBHOOK_SECRET=your-webhook-secret\nsupabase secrets set INTERNAL_WEBHOOK_SECRET=your-internal-secret\n```\n\n### 2. Deploy All Functions\n\n```bash\n# Deploy all functions\nsupabase functions deploy\n\n# Or deploy specific function\nsupabase functions deploy scheduled-scraper\nsupabase functions deploy city-scraper\nsupabase functions deploy venue-scraper\nsupabase functions deploy webhook-handler\nsupabase functions deploy health-check\nsupabase functions deploy rpc-functions\n```\n\n### 3. Set Up Cron Jobs\n\nIn Supabase Dashboard:\n\n1. Go to **Edge Functions** ‚Üí **Cron Jobs**\n2. Add cron job for `scheduled-scraper`:\n   - Function: `scheduled-scraper`\n   - Cron: `*/30 * * * *` (every 30 minutes)\n   - HTTP Method: `POST`\n\n3. Add cron job for `health-check`:\n   - Function: `health-check`\n   - Cron: `*/5 * * * *` (every 5 minutes)\n   - HTTP Method: `POST`\n\n## üß™ Testing Functions\n\n### 1. Test Scheduled Scraper\n\n```bash\ncurl -X POST 'http://127.0.0.1:54321/functions/v1/scheduled-scraper' \\\n  -H 'Authorization: Bearer your-service-role-key' \\\n  -H 'Content-Type: application/json' \\\n  -d '{}'\n```\n\n### 2. Test City Scraper\n\n```bash\ncurl -X POST 'http://127.0.0.1:54321/functions/v1/city-scraper' \\\n  -H 'Authorization: Bearer your-service-role-key' \\\n  -H 'Content-Type: application/json' \\\n  -d '{\n    \"target\": \"San Francisco\",\n    \"options\": {\n      \"max_venues\": 50,\n      \"max_events\": 200\n    }\n  }'\n```\n\n### 3. Test Venue Scraper\n\n```bash\ncurl -X POST 'http://127.0.0.1:54321/functions/v1/venue-scraper' \\\n  -H 'Authorization: Bearer your-service-role-key' \\\n  -H 'Content-Type: application/json' \\\n  -d '{\n    \"venue_id\": \"venue-uuid-here\",\n    \"options\": {\n      \"max_events\": 100\n    }\n  }'\n```\n\n### 4. Test Webhook Handler\n\n```bash\ncurl -X POST 'http://127.0.0.1:54321/functions/v1/webhook-handler' \\\n  -H 'Authorization: Bearer your-service-role-key' \\\n  -H 'Content-Type: application/json' \\\n  -d '{\n    \"type\": \"event.created\",\n    \"source\": \"eventbrite\",\n    \"timestamp\": \"2024-12-21T10:00:00Z\",\n    \"data\": {\n      \"event_id\": \"test-event-123\",\n      \"title\": \"Test Event\",\n      \"category\": \"music\"\n    }\n  }'\n```\n\n### 5. Test Health Check\n\n```bash\ncurl -X POST 'http://127.0.0.1:54321/functions/v1/health-check' \\\n  -H 'Authorization: Bearer your-service-role-key' \\\n  -H 'Content-Type: application/json' \\\n  -d '{}'\n```\n\n### 6. Test RPC Functions\n\n```bash\n# Test geo search\ncurl -X POST 'http://127.0.0.1:54321/functions/v1/rpc-functions' \\\n  -H 'Authorization: Bearer your-service-role-key' \\\n  -H 'Content-Type: application/json' \\\n  -d '{\n    \"function\": \"search_events_nearby\",\n    \"params\": {\n      \"latitude\": 37.7749,\n      \"longitude\": -122.4194,\n      \"radius_km\": 10,\n      \"limit\": 20\n    }\n  }'\n\n# Test personalized events\ncurl -X POST 'http://127.0.0.1:54321/functions/v1/rpc-functions' \\\n  -H 'Authorization: Bearer your-service-role-key' \\\n  -H 'Content-Type: application/json' \\\n  -d '{\n    \"function\": \"get_personalized_events\",\n    \"params\": {\n      \"user_id\": \"user-uuid-here\",\n      \"location\": {\n        \"latitude\": 37.7749,\n        \"longitude\": -122.4194\n      },\n      \"limit\": 20\n    }\n  }'\n```\n\n## üìä Monitoring and Logs\n\n### 1. View Function Logs\n\n```bash\n# View logs for specific function\nsupabase functions logs scheduled-scraper\n\n# Follow logs in real-time\nsupabase functions logs --follow\n```\n\n### 2. Monitor Function Performance\n\nIn Supabase Dashboard:\n\n1. Go to **Edge Functions**\n2. Click on function name\n3. View **Invocations**, **Errors**, and **Logs** tabs\n\n### 3. Set Up Alerting\n\nCreate alerts based on:\n- Function error rates\n- Function execution duration\n- Health check failures\n- Scraping job failures\n\n## üîç Troubleshooting\n\n### Common Issues\n\n1. **Function timeout**:\n   - Check function execution time\n   - Optimize scraping logic\n   - Break down large operations\n\n2. **API rate limits**:\n   - Implement proper rate limiting\n   - Add retry logic with exponential backoff\n   - Use webhook delays\n\n3. **Memory issues**:\n   - Process data in smaller chunks\n   - Clean up variables and connections\n   - Optimize data structures\n\n4. **Database connection errors**:\n   - Check connection limits\n   - Implement connection pooling\n   - Handle connection timeouts\n\n### Debug Mode\n\n```bash\n# Enable debug logging\nexport SUPABASE_DEBUG=true\n\n# Run function with debug info\nsupabase functions serve --debug\n```\n\n## üîÑ Development Workflow\n\n### 1. Local Development\n\n```bash\n# Make changes to function code\n# Test locally\nsupabase functions serve\n\n# Test function\ncurl -X POST 'http://127.0.0.1:54321/functions/v1/your-function'\n```\n\n### 2. Deploy Changes\n\n```bash\n# Deploy updated function\nsupabase functions deploy your-function\n\n# Verify deployment\ncurl -X POST 'https://your-project.supabase.co/functions/v1/your-function'\n```\n\n### 3. Monitor Production\n\n- Check function logs\n- Monitor error rates\n- Verify scraping jobs\n- Check health status\n\n## üõ°Ô∏è Security Best Practices\n\n1. **Environment Variables**:\n   - Never commit secrets to code\n   - Use Supabase secrets management\n   - Rotate API keys regularly\n\n2. **Function Security**:\n   - Validate all inputs\n   - Implement rate limiting\n   - Use proper error handling\n\n3. **Database Security**:\n   - Use Row Level Security (RLS)\n   - Validate user permissions\n   - Sanitize queries\n\n4. **Webhook Security**:\n   - Verify webhook signatures\n   - Use HTTPS only\n   - Implement replay protection\n\n## üìà Performance Optimization\n\n1. **Function Optimization**:\n   - Minimize cold starts\n   - Optimize imports\n   - Use efficient algorithms\n\n2. **Database Optimization**:\n   - Use proper indexes\n   - Optimize queries\n   - Implement caching\n\n3. **Scraping Optimization**:\n   - Implement smart rate limiting\n   - Use concurrent requests wisely\n   - Cache responses when possible\n\n## üîó Useful Commands\n\n```bash\n# View all functions\nsupabase functions list\n\n# Delete function\nsupabase functions delete function-name\n\n# View function details\nsupabase functions inspect function-name\n\n# Download function logs\nsupabase functions logs function-name --output logs.txt\n\n# Test function with file input\nsupabase functions serve\ncurl -X POST 'http://127.0.0.1:54321/functions/v1/function-name' \\\n  -H 'Content-Type: application/json' \\\n  -d @test-payload.json\n```\n\n## üìö Additional Resources\n\n- [Supabase Edge Functions Documentation](https://supabase.com/docs/guides/functions)\n- [Deno Runtime Documentation](https://deno.land/manual)\n- [Web API Standards](https://developer.mozilla.org/en-US/docs/Web/API)\n- [Supabase CLI Reference](https://supabase.com/docs/reference/cli)\n\n---\n\n## Next Steps\n\n1. Set up monitoring dashboards\n2. Implement advanced error handling\n3. Add performance metrics collection\n4. Set up automated testing\n5. Create deployment pipelines